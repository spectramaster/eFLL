# 温控系统案例

本文档展示了如何基于 eFLL 构建一个双输入单输出的温度控制器，涵盖输入输出映射、调试流程与常见注意事项，帮助团队快速落地。

## 系统概览

- **控制目标**：在暖风管道中保持目标温度，响应外部环境温度变化和负载扰动。
- **硬件平台**：STM32F407 + 热电偶传感器 + 加热丝 + PWM 风扇。
- **软件架构**：主循环 10 ms 周期执行模糊控制，使用 eFLL 提供的 `Fuzzy` 类管理规则。

## 输入输出映射

| 名称 | 类型 | 采样单位 | 说明 |
| ---- | ---- | -------- | ---- |
| `temperature_error` | 模糊输入 | 摄氏度 (°C) | 目标温度与实际温度差值，范围 -20 ~ +20 |
| `error_derivative` | 模糊输入 | 摄氏度/周期 | 误差变化率，范围 -5 ~ +5 |
| `heater_pwm` | 模糊输出 | 占空比 0~100% | 控制加热丝的 PWM 占空比 |

- 将输入值转换为归一化区间，例如 `temperature_error` 使用 `error_norm = clamp(error * 50.0f, -1000, 1000)`，确保与 `FuzzySet` 构造参数一致。
- 隶属度划分建议：`temperature_error` 包含 {Cold, Cool, Warm, Hot} 四个集合；`error_derivative` 包含 {CoolingFast, Stable, HeatingFast} 三个集合；输出 `heater_pwm` 包含 {Off, Low, Medium, High}。

## 调试流程

1. **参数验证**：在桌面环境下创建单元测试，向模糊系统注入典型误差组合，检查推理结果是否符合预期。例如当误差为 +10°C、变化率为 -1°C/周期时，应输出接近 `Medium` 的 PWM。
2. **在线监控**：在 STM32 上通过串口打印当前输入、输出值与命中的规则编号，必要时加入断言确保输入范围合法。
3. **分段调试**：
   - 固定 `error_derivative=0`，扫描 `temperature_error`，绘制输出曲线，验证 defuzzify 的连续性。
   - 固定 `temperature_error`，扫描 `error_derivative`，观察系统对变化率的灵敏度。
4. **闭环试运行**：在实验环境中逐步提高目标温度，监控温度波动与执行器饱和情况。利用示波器或逻辑分析仪检查 PWM 信号是否与控制输出匹配。
5. **参数优化**：若出现超调或震荡，可调整输出集合的隶属度上限或修改规则权重。建议一次只调整一项，并记录变更。

## 注意事项

- **定点实现**：若使用定点模式，请确保归一化比例与 `docs/integration_guide.md` 中的配置一致，并在调试日志中同时输出原始值与缩放值。
- **传感器噪声**：对热电偶读数进行中值或滑动平均滤波，防止噪声干扰模糊推理。
- **执行器保护**：为加热丝与风扇设置上限保护，必要时在 defuzzify 结果后添加速率限制器，避免频繁大幅切换导致硬件疲劳。
- **安全联锁**：在温度传感器失效或超过安全阈值时，应旁路模糊控制器，立即关闭加热并上报故障。

## 进一步阅读

- [集成指南](./integration_guide.md)
- `examples/TemperatureControl`（可自定义添加）或其他项目中的实现案例
- STM32 HAL 文档中的定时器/PWM 配置章节
